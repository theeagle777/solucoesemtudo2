"""
BOT MULTI-MARKETPLACE AFILIADO PROFISSIONAL v3.0
=================================================
Integra√ß√£o: Shopee, Amazon, Mercado Livre, Magazine Luiza, AliExpress
Autor: Marketing de Milh√µes
Vers√£o: 3.0.0
"""

import os
import json
import logging
import asyncio
import aiohttp
import re
import hashlib
from datetime import datetime, timedelta
from typing import List, Dict, Optional, Tuple
from dataclasses import dataclass, field, asdict
from collections import defaultdict, deque
from urllib.parse import quote_plus, urlencode
import random
from enum import Enum
from functools import wraps
import sqlite3
from time import time
import threading

# Bibliotecas externas
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, filters, ContextTypes
)
from flask import Flask, jsonify, render_template_string, request
from flask_cors import CORS

# ==================== CONFIGURA√á√ÉO DE LOGGING ====================

logging.basicConfig(
    format='%(asctime)s | %(levelname)-8s | %(name)s | %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('bot_multi_afiliado.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Carregar vari√°veis de ambiente
load_dotenv()

# ==================== ENUMS ====================

class Marketplace(Enum):
    """Enumera√ß√£o dos marketplaces suportados"""
    SHOPEE = "Shopee"
    MERCADO_LIVRE = "Mercado Livre"
    AMAZON = "Amazon"
    MAGAZINE_LUIZA = "Magazine Luiza"
    ALIEXPRESS = "AliExpress"
    OLIST = "Olist"

class NivelEngajamento(Enum):
    """N√≠veis de engajamento do usu√°rio"""
    NOVO = "novo"
    ATIVO = "ativo"
    FIEL = "fiel"
    VIP = "vip"

# ==================== DATACLASSES ====================

@dataclass
class Produto:
    """Modelo de dados para produtos"""
    id: str
    nome: str
    preco: float
    preco_original: float
    desconto: float
    url: str
    url_afiliado: str
    imagem: str
    vendas: int
    avaliacao: float
    num_avaliacoes: int
    loja: str
    loja_id: str
    categoria: str
    estoque: int
    marketplace: str
    frete_gratis: bool
    cupom: Optional[str] = None
    cashback: float = 0.0
    score_conversao: float = 0.0
    comissao_percentual: float = 0.0
    
    def to_dict(self) -> Dict:
        """Converte o produto para dicion√°rio"""
        return asdict(self)
    
    @property
    def comissao_estimada(self) -> float:
        """Calcula comiss√£o estimada"""
        return self.preco * (self.comissao_percentual / 100)
    
    @property
    def economia(self) -> float:
        """Calcula economia em reais"""
        return max(0, self.preco_original - self.preco)

@dataclass
class Usuario:
    """Modelo de dados para usu√°rios"""
    user_id: int
    username: str
    nome: str
    data_registro: datetime
    produtos_visualizados: int = 0
    links_clicados: int = 0
    alertas_ativos: int = 0
    preferencias: List[str] = field(default_factory=list)
    marketplaces_favoritos: List[str] = field(default_factory=list)
    ultima_interacao: Optional[datetime] = None
    nivel_engajamento: str = NivelEngajamento.NOVO.value
    
    @property
    def taxa_conversao(self) -> float:
        """Calcula taxa de convers√£o do usu√°rio"""
        if self.produtos_visualizados == 0:
            return 0.0
        return (self.links_clicados / self.produtos_visualizados) * 100
    
    def atualizar_nivel_engajamento(self):
        """Atualiza o n√≠vel de engajamento baseado na atividade"""
        if self.links_clicados >= 50:
            self.nivel_engajamento = NivelEngajamento.VIP.value
        elif self.links_clicados >= 20:
            self.nivel_engajamento = NivelEngajamento.FIEL.value
        elif self.links_clicados >= 5:
            self.nivel_engajamento = NivelEngajamento.ATIVO.value

# ==================== CACHE ====================

class CacheManager:
    """Gerenciador de cache em mem√≥ria"""
    
    def __init__(self, ttl_seconds: int = 300):
        self.cache: Dict[str, Tuple[any, float]] = {}
        self.ttl = ttl_seconds
    
    def get(self, key: str) -> Optional[any]:
        """Busca valor no cache"""
        if key in self.cache:
            value, timestamp = self.cache[key]
            if time() - timestamp < self.ttl:
                return value
            else:
                del self.cache[key]
        return None
    
    def set(self, key: str, value: any):
        """Armazena valor no cache"""
        self.cache[key] = (value, time())
    
    def clear(self):
        """Limpa todo o cache"""
        self.cache.clear()
    
    def cleanup(self):
        """Remove entradas expiradas"""
        now = time()
        expired = [k for k, (_, ts) in self.cache.items() if now - ts >= self.ttl]
        for key in expired:
            del self.cache[key]

# ==================== DATABASE ====================

class DatabaseManager:
    """Gerenciador de banco de dados SQLite com pool de conex√µes"""
    
    def __init__(self, db_path: str = 'multi_afiliado.db'):
        self.db_path = db_path
        self._lock = threading.Lock()
        self._criar_tabelas()
        logger.info(f"‚úì Banco de dados inicializado: {db_path}")
    
    def _get_connection(self):
        """Cria conex√£o thread-safe"""
        conn = sqlite3.connect(self.db_path, check_same_thread=False)
        conn.row_factory = sqlite3.Row
        return conn
    
    def _criar_tabelas(self):
        """Cria estrutura do banco de dados"""
        with self._lock:
            conn = self._get_connection()
            try:
                cursor = conn.cursor()
                
                # Tabela de usu√°rios
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS usuarios (
                        user_id INTEGER PRIMARY KEY,
                        username TEXT,
                        nome TEXT,
                        data_registro TIMESTAMP,
                        produtos_visualizados INTEGER DEFAULT 0,
                        links_clicados INTEGER DEFAULT 0,
                        alertas_ativos INTEGER DEFAULT 0,
                        preferencias TEXT,
                        marketplaces_favoritos TEXT,
                        ultima_interacao TIMESTAMP,
                        nivel_engajamento TEXT DEFAULT 'novo'
                    )
                ''')
                
                # Tabela de produtos visualizados
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS produtos_visualizados (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        produto_id TEXT,
                        marketplace TEXT,
                        timestamp TIMESTAMP,
                        FOREIGN KEY (user_id) REFERENCES usuarios(user_id)
                    )
                ''')
                
                # √çndices para performance
                cursor.execute('''
                    CREATE INDEX IF NOT EXISTS idx_produtos_user 
                    ON produtos_visualizados(user_id)
                ''')
                
                cursor.execute('''
                    CREATE INDEX IF NOT EXISTS idx_produtos_timestamp 
                    ON produtos_visualizados(timestamp)
                ''')
                
                # Tabela de cliques em links de afiliados
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS cliques_afiliado (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        produto_id TEXT,
                        marketplace TEXT,
                        url TEXT,
                        timestamp TIMESTAMP,
                        converteu BOOLEAN DEFAULT 0,
                        valor_estimado REAL DEFAULT 0,
                        FOREIGN KEY (user_id) REFERENCES usuarios(user_id)
                    )
                ''')
                
                cursor.execute('''
                    CREATE INDEX IF NOT EXISTS idx_cliques_user 
                    ON cliques_afiliado(user_id)
                ''')
                
                # Tabela de alertas de pre√ßo
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS alertas_preco (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        produto_id TEXT,
                        marketplace TEXT,
                        preco_alvo REAL,
                        ativo BOOLEAN DEFAULT 1,
                        criado_em TIMESTAMP,
                        FOREIGN KEY (user_id) REFERENCES usuarios(user_id)
                    )
                ''')
                
                # Tabela de estat√≠sticas por marketplace
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS estatisticas_marketplace (
                        marketplace TEXT PRIMARY KEY,
                        total_produtos INTEGER DEFAULT 0,
                        total_cliques INTEGER DEFAULT 0,
                        total_conversoes INTEGER DEFAULT 0,
                        comissao_total REAL DEFAULT 0,
                        ultima_atualizacao TIMESTAMP
                    )
                ''')
                
                conn.commit()
                
            except Exception as e:
                logger.error(f"Erro ao criar tabelas: {e}")
                conn.rollback()
            finally:
                conn.close()
    
    def salvar_usuario(self, usuario: Usuario):
        """Salva ou atualiza usu√°rio"""
        with self._lock:
            conn = self._get_connection()
            try:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT OR REPLACE INTO usuarios 
                    (user_id, username, nome, data_registro, produtos_visualizados, 
                     links_clicados, alertas_ativos, preferencias, marketplaces_favoritos,
                     ultima_interacao, nivel_engajamento)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    usuario.user_id, usuario.username, usuario.nome,
                    usuario.data_registro, usuario.produtos_visualizados,
                    usuario.links_clicados, usuario.alertas_ativos,
                    json.dumps(usuario.preferencias),
                    json.dumps(usuario.marketplaces_favoritos),
                    usuario.ultima_interacao, usuario.nivel_engajamento
                ))
                conn.commit()
            except Exception as e:
                logger.error(f"Erro ao salvar usu√°rio: {e}")
                conn.rollback()
            finally:
                conn.close()
    
    def obter_usuario(self, user_id: int) -> Optional[Usuario]:
        """Busca usu√°rio pelo ID"""
        conn = self._get_connection()
        try:
            cursor = conn.cursor()
            cursor.execute('SELECT * FROM usuarios WHERE user_id = ?', (user_id,))
            row = cursor.fetchone()
            
            if row:
                return Usuario(
                    user_id=row['user_id'],
                    username=row['username'] or '',
                    nome=row['nome'],
                    data_registro=datetime.fromisoformat(row['data_registro']),
                    produtos_visualizados=row['produtos_visualizados'],
                    links_clicados=row['links_clicados'],
                    alertas_ativos=row['alertas_ativos'],
                    preferencias=json.loads(row['preferencias']) if row['preferencias'] else [],
                    marketplaces_favoritos=json.loads(row['marketplaces_favoritos']) if row['marketplaces_favoritos'] else [],
                    ultima_interacao=datetime.fromisoformat(row['ultima_interacao']) if row['ultima_interacao'] else None,
                    nivel_engajamento=row['nivel_engajamento']
                )
        except Exception as e:
            logger.error(f"Erro ao obter usu√°rio: {e}")
        finally:
            conn.close()
        return None
    
    def registrar_visualizacao(self, user_id: int, produto_id: str, marketplace: str):
        """Registra visualiza√ß√£o de produto"""
        with self._lock:
            conn = self._get_connection()
            try:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO produtos_visualizados (user_id, produto_id, marketplace, timestamp)
                    VALUES (?, ?, ?, ?)
                ''', (user_id, produto_id, marketplace, datetime.now()))
                
                cursor.execute('''
                    UPDATE usuarios 
                    SET produtos_visualizados = produtos_visualizados + 1,
                        ultima_interacao = ? 
                    WHERE user_id = ?
                ''', (datetime.now(), user_id))
                
                conn.commit()
            except Exception as e:
                logger.error(f"Erro ao registrar visualiza√ß√£o: {e}")
                conn.rollback()
            finally:
                conn.close()
    
    def registrar_clique(self, user_id: int, produto_id: str, marketplace: str, 
                        url: str, valor_estimado: float = 0):
        """Registra clique em link de afiliado"""
        with self._lock:
            conn = self._get_connection()
            try:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO cliques_afiliado 
                    (user_id, produto_id, marketplace, url, timestamp, valor_estimado)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (user_id, produto_id, marketplace, url, datetime.now(), valor_estimado))
                
                cursor.execute('''
                    UPDATE usuarios 
                    SET links_clicados = links_clicados + 1,
                        ultima_interacao = ? 
                    WHERE user_id = ?
                ''', (datetime.now(), user_id))
                
                cursor.execute('''
                    INSERT OR REPLACE INTO estatisticas_marketplace
                    (marketplace, total_cliques, ultima_atualizacao)
                    VALUES (
                        ?,
                        COALESCE((SELECT total_cliques FROM estatisticas_marketplace WHERE marketplace = ?), 0) + 1,
                        ?
                    )
                ''', (marketplace, marketplace, datetime.now()))
                
                conn.commit()
            except Exception as e:
                logger.error(f"Erro ao registrar clique: {e}")
                conn.rollback()
            finally:
                conn.close()
    
    def obter_estatisticas(self) -> Dict:
        """Retorna estat√≠sticas gerais do sistema"""
        conn = self._get_connection()
        try:
            cursor = conn.cursor()
            
            # Total de usu√°rios
            cursor.execute('SELECT COUNT(*) as total FROM usuarios')
            total_usuarios = cursor.fetchone()['total']
            
            # Cliques hoje
            cursor.execute('''
                SELECT COUNT(*) as total FROM cliques_afiliado 
                WHERE DATE(timestamp) = DATE('now')
            ''')
            cliques_hoje = cursor.fetchone()['total']
            
            # Visualiza√ß√µes hoje
            cursor.execute('''
                SELECT COUNT(*) as total FROM produtos_visualizados 
                WHERE DATE(timestamp) = DATE('now')
            ''')
            visualizacoes_hoje = cursor.fetchone()['total']
            
            # Visualiza√ß√µes √∫ltima semana
            cursor.execute('''
                SELECT COUNT(*) as total FROM produtos_visualizados 
                WHERE DATE(timestamp) >= DATE('now', '-7 days')
            ''')
            visualizacoes_semana = cursor.fetchone()['total']
            
            # Top marketplaces
            cursor.execute('''
                SELECT marketplace, COUNT(*) as cliques 
                FROM cliques_afiliado
                GROUP BY marketplace 
                ORDER BY cliques DESC
                LIMIT 5
            ''')
            top_marketplaces = [{'nome': row['marketplace'], 'cliques': row['cliques']} for row in cursor.fetchall()]
            
            # Taxa de convers√£o
            taxa_conversao = (cliques_hoje / max(visualizacoes_hoje, 1)) * 100
            
            # Comiss√£o estimada total
            cursor.execute('''
                SELECT SUM(valor_estimado) as total 
                FROM cliques_afiliado
            ''')
            comissao_total = cursor.fetchone()['total'] or 0
            
            # Economia estimada (m√©dia 15% de economia por produto)
            economia_estimada = visualizacoes_hoje * 50 * 0.15  # R$ 50 m√©dio por produto
            
            return {
                'total_usuarios': total_usuarios,
                'cliques_hoje': cliques_hoje,
                'visualizacoes_hoje': visualizacoes_hoje,
                'visualizacoes_semana': visualizacoes_semana,
                'taxa_conversao': round(taxa_conversao, 2),
                'top_marketplaces': top_marketplaces,
                'comissao_estimada_total': round(comissao_total, 2),
                'economia_total': round(economia_estimada, 2),
                'ultima_atualizacao': datetime.now().isoformat(),
                'status': 'online'
            }
            
        except Exception as e:
            logger.error(f"Erro ao obter estat√≠sticas: {e}")
            return {
                'total_usuarios': 0,
                'cliques_hoje': 0,
                'visualizacoes_hoje': 0,
                'economia_total': 0,
                'top_marketplaces': [],
                'status': 'error'
            }
        finally:
            conn.close()

# ==================== RATE LIMITER ====================

class RateLimiter:
    """Controle de taxa de requisi√ß√µes com jitter"""
    
    def __init__(self, max_requests: int = 30, time_window: int = 60):
        self.max_requests = max_requests
        self.time_window = time_window
        self.requests = deque()
        self._lock = asyncio.Lock()
    
    async def acquire(self):
        """Aguarda at√© poder fazer nova requisi√ß√£o"""
        async with self._lock:
            now = time()
            
            # Remove requisi√ß√µes antigas
            while self.requests and self.requests[0] < now - self.time_window:
                self.requests.popleft()
            
            # Se atingiu o limite, aguarda
            if len(self.requests) >= self.max_requests:
                sleep_time = self.requests[0] + self.time_window - now
                sleep_time += random.uniform(1, 3)
                logger.debug(f"Rate limit atingido. Aguardando {sleep_time:.2f}s")
                await asyncio.sleep(sleep_time)
                return await self.acquire()
            
            await asyncio.sleep(random.uniform(0.5, 2.0))
            self.requests.append(now)

# ==================== DECORADORES ====================

def retry_on_failure(max_attempts: int = 3, delay: float = 1.0):
    """Decorator para retry autom√°tico em caso de falha"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_attempts - 1:
                        logger.error(f"Falha ap√≥s {max_attempts} tentativas: {e}")
                        raise
                    logger.warning(f"Tentativa {attempt + 1} falhou: {e}. Retentando...")
                    await asyncio.sleep(delay * (attempt + 1))
        return wrapper
    return decorator

# ==================== APIS DOS MARKETPLACES ====================

class BaseMarketplaceAPI:
    """Classe base para APIs de marketplaces"""
    
    def __init__(self, marketplace: Marketplace, comissao_media: float):
        self.marketplace = marketplace.value
        self.comissao_media = comissao_media
        self.rate_limiter = RateLimiter()
        self.cache = CacheManager(ttl_seconds=300)
        self.user_agents = [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        ]
    
    def _get_headers(self) -> Dict:
        """Retorna headers HTTP aleat√≥rios"""
        return {
            'User-Agent': random.choice(self.user_agents),
            'Accept': 'application/json',
            'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }
    
    def _get_cache_key(self, termo: str, limit: int) -> str:
        """Gera chave de cache √∫nica"""
        raw = f"{self.marketplace}:{termo}:{limit}"
        return hashlib.md5(raw.encode()).hexdigest()
    
    async def buscar_produtos(self, termo: str, limit: int = 20) -> List[Produto]:
        """M√©todo abstrato - deve ser implementado pelas subclasses"""
        raise NotImplementedError

class ShopeeAffiliateAPI(BaseMarketplaceAPI):
    """API da Shopee com rate limiting e cache"""
    
    def __init__(self):
        super().__init__(Marketplace.SHOPEE, comissao_media=8.0)
        self.base_url = "https://shopee.com.br"
        self.api_url = "https://shopee.com.br/api/v4/search/search_items"
        self.affiliate_code = os.getenv('SHOPEE_AFFILIATE_CODE', '')
        
        if not self.affiliate_code:
            logger.warning("‚ö†Ô∏è SHOPEE_AFFILIATE_CODE n√£o configurado!")
    
    def _gerar_link_afiliado(self, shop_id: str, item_id: str) -> str:
        """Gera link de afiliado da Shopee"""
        base_link = f"{self.base_url}/product/{shop_id}/{item_id}"
        if self.affiliate_code:
            return f"{base_link}?af_siteid={self.affiliate_code}"
        return base_link
    
    @retry_on_failure(max_attempts=3)
    async def buscar_produtos(self, termo: str, limit: int = 20) -> List[Produto]:
        """Busca produtos na Shopee"""
        cache_key = self._get_cache_key(termo, limit)
        cached = self.cache.get(cache_key)
        if cached:
            logger.debug(f"Cache hit para: {termo}")
            return cached
        
        await self.rate_limiter.acquire()
        
        params = {
            'by': 'relevancy',
            'keyword': termo,
            'limit': min(limit, 60),
            'newest': 0,
            'order': 'desc',
            'page_type': 'search',
            'version': 2
        }
        
        timeout = aiohttp.ClientTimeout(total=30)
        async with aiohttp.ClientSession(timeout=timeout) as session:
            try:
                async with session.get(
                    self.api_url, 
                    params=params, 
                    headers=self._get_headers()
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        produtos = self._parse_produtos(data)
                        self.cache.set(cache_key, produtos)
                        logger.info(f"‚úì Shopee: {len(produtos)} produtos encontrados para '{termo}'")
                        return produtos
                    else:
                        logger.warning(f"Shopee retornou status {response.status}")
                        
            except asyncio.TimeoutError:
                logger.error(f"Timeout ao buscar produtos na Shopee")
            except Exception as e:
                logger.error(f"Erro na Shopee: {e}")
        
        return []
    
    def _parse_produtos(self, data: Dict) -> List[Produto]:
        """Parseia resposta da API da Shopee"""
        produtos = []
        
        if 'items' not in data:
            return produtos
        
        for item in data['items']:
            try:
                if 'item_basic' not in item:
                    continue
                
                info = item['item_basic']
                
                preco_atual = info.get('price', 0) / 100000
                preco_original = info.get('price_before_discount', preco_atual * 100000) / 100000
                desconto = info.get('raw_discount', 0)
                
                shop_id = str(info.get('shopid', ''))
                item_id = str(info.get('itemid', ''))
                
                rating_info = info.get('item_rating', {})
                avaliacao = rating_info.get('rating_star', 0)
                rating_counts = rating_info.get('rating_count', [0, 0, 0, 0, 0, 0])
                num_avaliacoes = sum(rating_counts)
                
                vendas = info.get('historical_sold', 0)
                score = (
                    vendas * 0.4 +
                    avaliacao * 10 +
                    num_avaliacoes * 0.1 +
                    (100 - desconto) * 0.5
                )
                
                produto = Produto(
                    id=item_id,
                    nome=info.get('name', 'Produto')[:200],
                    preco=round(preco_atual, 2),
                    preco_original=round(preco_original, 2),
                    desconto=round(desconto, 1),
                    url=f"{self.base_url}/product/{shop_id}/{item_id}",
                    url_afiliado=self._gerar_link_afiliado(shop_id, item_id),
                    imagem=f"https://cf.shopee.com.br/file/{info.get('image', '')}",
                    vendas=vendas,
                    avaliacao=round(avaliacao, 1),
                    num_avaliacoes=num_avaliacoes,
                    loja=info.get('shop_name', 'Shopee')[:100],
                    loja_id=shop_id,
                    categoria=str(info.get('catid', '')),
                    estoque=info.get('stock', 0),
                    marketplace=self.marketplace,
                    frete_gratis=info.get('show_free_shipping', False),
                    cupom=info.get('voucher_info', {}).get('voucher_code'),
                    comissao_percentual=self.comissao_media,
                    score_conversao=round(score, 2)
                )
                
                produtos.append(produto)
                
            except Exception as e:
                logger.debug(f"Erro ao parsear item da Shopee: {e}")
                continue
        
        return produtos

class MercadoLivreAPI(BaseMarketplaceAPI):
    """API do Mercado Livre"""
    
    def __init__(self):
        super().__init__(Marketplace.MERCADO_LIVRE, comissao_media=6.0)
        self.base_url = "https://api.mercadolibre.com"
        self.affiliate_id = os.getenv('MERCADOLIVRE_AFFILIATE_ID', '')
        
        if not self.affiliate_id:
            logger.warning("‚ö†Ô∏è MERCADOLIVRE_AFFILIATE_ID n√£o configurado!")
    
    @retry_on_failure(max_attempts=3)
    async def buscar_produtos(self, termo: str, limit: int = 20) -> List[Produto]:
        """Busca produtos no Mercado Livre"""
        cache_key = self._get_cache_key(termo, limit)
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        await self.rate_limiter.acquire()
        
        url = f"{self.base_url}/sites/MLB/search"
        params = {
            'q': termo,
            'limit': min(limit, 50),
            'sort': 'relevance',
            'condition': 'new'
        }
        
        timeout = aiohttp.ClientTimeout(total=30)
        async with aiohttp.ClientSession(timeout=timeout) as session:
            try:
                async with session.get(url, params=params, headers=self._get_headers()) as response:
                    if response.status == 200:
                        data = await response.json()
                        produtos = self._parse_produtos(data)
                        self.cache.set(cache_key, produtos)
                        logger.info(f"‚úì Mercado Livre: {len(produtos)} produtos encontrados")
                        return produtos
                        
            except Exception as e:
                logger.error(f"Erro no Mercado Livre: {e}")
        
        return []
    
    def _parse_produtos(self, data: Dict) -> List[Produto]:
        """Parseia resposta do Mercado Livre"""
        produtos = []
        
        for item in data.get('results', []):
            try:
                preco_atual = item.get('price', 0)
                preco_original = item.get('original_price', preco_atual)
                desconto = ((preco_original - preco_atual) / preco_original * 100) if preco_original > preco_atual else 0
                
                vendas = item.get('sold_quantity', 0)
                reviews = item.get('reviews', {})
                avaliacao = reviews.get('rating_average', 0)
                num_avaliacoes = reviews.get('total', 0)
                
                score = vendas * 0.5 + avaliacao * 15 + num_avaliacoes * 0.2
                
                produto = Produto(
                    id=item.get('id', ''),
                    nome=item.get('title', 'Produto')[:200],
                    preco=round(preco_atual, 2),
                    preco_original=round(preco_original, 2),
                    desconto=round(desconto, 1),
                    url=item.get('permalink', ''),
                    url_afiliado=self._gerar_link_afiliado(item.get('permalink', '')),
                    imagem=item.get('thumbnail', '').replace('http://', 'https://'),
                    vendas=vendas,
                    avaliacao=round(avaliacao, 1),
                    num_avaliacoes=num_avaliacoes,
                    loja=item.get('seller', {}).get('nickname', 'ML')[:100],
                    loja_id=str(item.get('seller_id', '')),
                    categoria=item.get('category_id', ''),
                    estoque=item.get('available_quantity', 0),
                    marketplace=self.marketplace,
                    frete_gratis=item.get('shipping', {}).get('free_shipping', False),
                    comissao_percentual=self.comissao_media,
                    score_conversao=round(score, 2)
                )
                
                produtos.append(produto)
                
            except Exception as e:
                logger.debug(f"Erro ao parsear item do ML: {e}")
                continue
        
        return produtos
    
    def _gerar_link_afiliado(self, url: str) -> str:
        """Gera link de afiliado do Mercado Livre"""
        if not url:
            return url
        
        if self.affiliate_id:
            separator = '&' if '?' in url else '?'
            return f"{url}{separator}pdp_dl=true&affiliate_id={self.affiliate_id}"
        return url

class AmazonAffiliateAPI(BaseMarketplaceAPI):
    """API da Amazon - Placeholder"""
    
    def __init__(self):
        super().__init__(Marketplace.AMAZON, comissao_media=4.0)
        self.access_key = os.getenv('AMAZON_ACCESS_KEY', '')
        self.secret_key = os.getenv('AMAZON_SECRET_KEY', '')
        self.partner_tag = os.getenv('AMAZON_PARTNER_TAG', '')
    
    async def buscar_produtos(self, termo: str, limit: int = 10) -> List[Produto]:
        """Amazon requer Product Advertising API - implementa√ß√£o futura"""
        if not all([self.access_key, self.secret_key, self.partner_tag]):
            logger.debug("Credenciais Amazon n√£o configuradas")
        return []

class MagazineLuizaAPI(BaseMarketplaceAPI):
    """API da Magazine Luiza - Placeholder"""
    
    def __init__(self):
        super().__init__(Marketplace.MAGAZINE_LUIZA, comissao_media=5.0)
        self.api_key = os.getenv('MAGALU_API_KEY', '')
    
    async def buscar_produtos(self, termo: str, limit: int = 20) -> List[Produto]:
        """Magazine Luiza - implementa√ß√£o futura"""
        if not self.api_key:
            logger.debug("API Key Magazine Luiza n√£o configurada")
        return []

class AliExpressAPI(BaseMarketplaceAPI):
    """API do AliExpress - Placeholder"""
    
    def __init__(self):
        super().__init__(Marketplace.ALIEXPRESS, comissao_media=8.0)
        self.app_key = os.getenv('ALIEXPRESS_APP_KEY', '')
    
    async def buscar_produtos(self, termo: str, limit: int = 20) -> List[Produto]:
        """AliExpress - implementa√ß√£o futura"""
        if not self.app_key:
            logger.debug("Credenciais AliExpress n√£o configuradas")
        return []

# ==================== COMPARADOR MULTI-MARKETPLACE ====================

class ComparadorMultiMarketplace:
    """Comparador inteligente de produtos entre marketplaces"""
    
    def __init__(self):
        self.shopee = ShopeeAffiliateAPI()
        self.mercadolivre = MercadoLivreAPI()
        self.amazon = AmazonAffiliateAPI()
        self.magalu = MagazineLuizaAPI()
        self.aliexpress = AliExpressAPI()
    
    async def buscar_todos_marketplaces(self, termo: str, limit_por_marketplace: int = 15) -> Dict[str, List[Produto]]:
        """Busca paralela em todos os marketplaces"""
        logger.info(f"üîç Buscando '{termo}' em todos os marketplaces...")
        
        tasks = {
            'Shopee': self.shopee.buscar_produtos(termo, limit_por_marketplace),
            'Mercado Livre': self.mercadolivre.buscar_produtos(termo, limit_por_marketplace),
            'Amazon': self.amazon.buscar_produtos(termo, limit_por_marketplace),
            'Magazine Luiza': self.magalu.buscar_produtos(termo, limit_por_marketplace),
            'AliExpress': self.aliexpress.buscar_produtos(termo, limit_por_marketplace)
        }
        
        resultados = await asyncio.gather(*tasks.values(), return_exceptions=True)
        
        resultado_final = {}
        for (marketplace, _), resultado in zip(tasks.items(), resultados):
            if isinstance(resultado, list):
                resultado_final[marketplace] = resultado
            else:
                logger.warning(f"Erro ao buscar em {marketplace}: {resultado}")
                resultado_final[marketplace] = []
        
        total_produtos = sum(len(prods) for prods in resultado_final.values())
        logger.info(f"‚úì Total de {total_produtos} produtos encontrados")
        
        return resultado_final
    
    def comparar_precos(self, produtos_por_marketplace: Dict[str, List[Produto]]) -> Dict:
        """Compara pre√ßos e retorna melhores ofertas"""
        
        todos_produtos = []
        for marketplace, produtos in produtos_por_marketplace.items():
            todos_produtos.extend(produtos)
        
        if not todos_produtos:
            return {
                'produtos': [],
                'melhor_marketplace': None,
                'total_produtos': 0,
                'distribuicao': {},
                'economia_maxima': 0,
                'comissao_media': 0
            }
        
        produtos_agrupados = defaultdict(list)
        for p in todos_produtos:
            nome_norm = re.sub(r'[^\w\s]', '', p.nome.lower())[:50]
            produtos_agrupados[nome_norm].append(p)
        
        melhores_ofertas = []
        for nome, grupo in produtos_agrupados.items():
            if len(grupo) >= 1:
                grupo_ordenado = sorted(grupo, key=lambda x: x.score_conversao, reverse=True)
                melhor = grupo_ordenado[0]
                melhores_ofertas.append(melhor)
        
        melhores_ofertas.sort(key=lambda x: x.score_conversao, reverse=True)
        
        contador_marketplaces = defaultdict(int)
        economia_total = 0
        comissao_total = 0
        
        for oferta in melhores_ofertas[:20]:
            contador_marketplaces[oferta.marketplace] += 1
            economia_total += oferta.economia
            comissao_total += oferta.comissao_estimada
        
        melhor_marketplace = max(
            contador_marketplaces.items(), 
            key=lambda x: x[1]
        )[0] if contador_marketplaces else None
        
        return {
            'produtos': melhores_ofertas[:20],
            'melhor_marketplace': melhor_marketplace,
            'total_produtos': len(todos_produtos),
            'distribuicao': dict(contador_marketplaces),
            'economia_maxima': round(economia_total, 2),
            'comissao_media': round(comissao_total / max(len(melhores_ofertas[:20]), 1), 2)
        }

# ==================== MARKETING IA COM GROQ ====================

class MarketingAIGroq:
    """Gerador de copy usando Groq LLM"""
    
    def __init__(self):
        self.api_key = os.getenv('GROQ_API_KEY')
        self.base_url = 'https://api.groq.com/openai/v1/chat/completions'
        self.model = 'llama-3.3-70b-versatile'
        self.cache = CacheManager(ttl_seconds=600)
        
        if not self.api_key:
            logger.warning("‚ö†Ô∏è GROQ_API_KEY n√£o configurado - usando fallback")
    
    async def gerar_copy_multi_marketplace(self, produto: Produto, produtos_similares: List[Produto]) -> str:
        """Gera copy otimizada comparando com produtos similares"""
        
        if not self.api_key:
            return self._copy_fallback(produto)
        
        cache_key = f"copy_{produto.id}_{produto.marketplace}"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        precos_por_marketplace = {}
        for p in produtos_similares[:5]:
            if p.marketplace not in precos_por_marketplace or p.preco < precos_por_marketplace[p.marketplace]:
                precos_por_marketplace[p.marketplace] = p.preco
        
        comparacao_precos = "\n".join([
            f"- {k}: R$ {v:.2f}" 
            for k, v in sorted(precos_por_marketplace.items(), key=lambda x: x[1])
        ])
        
        prompt = f"""Crie uma copy ULTRA PERSUASIVA para venda de produto em e-commerce.

PRODUTO: {produto.nome[:100]}
Marketplace: {produto.marketplace}
Pre√ßo ATUAL: R$ {produto.preco:.2f}
Desconto: {produto.desconto:.0f}%
Vendas: {produto.vendas}+ unidades
Avalia√ß√£o: {produto.avaliacao}/5.0 ({produto.num_avaliacoes} reviews)
{'‚úì FRETE GR√ÅTIS' if produto.frete_gratis else ''}

COMPARA√á√ÉO COM CONCORRENTES:
{comparacao_precos if comparacao_precos else 'Melhor pre√ßo encontrado!'}

REGRAS ESTRITAS:
1. ZERO emojis
2. Destaque vantagem competitiva clara
3. Prova social forte (vendas + avalia√ß√µes)
4. Urg√™ncia e escassez
5. CTA direto e poderoso
6. Tom profissional mas persuasivo
7. M√°ximo 100 palavras

Foco em CONVERS√ÉO."""

        headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json'
        }
        
        payload = {
            'model': self.model,
            'messages': [
                {
                    'role': 'system', 
                    'content': 'Voc√™ √© o melhor copywriter de e-commerce do Brasil. Suas copies convertem em m√©dia 15% a mais.'
                },
                {'role': 'user', 'content': prompt}
            ],
            'temperature': 1.0,
            'max_tokens': 400,
            'top_p': 1,
            'stream': False
        }
        
        timeout = aiohttp.ClientTimeout(total=30)
        async with aiohttp.ClientSession(timeout=timeout) as session:
            try:
                async with session.post(self.base_url, json=payload, headers=headers) as response:
                    if response.status == 200:
                        data = await response.json()
                        copy = data['choices'][0]['message']['content'].strip()
                        self.cache.set(cache_key, copy)
                        return copy
                    else:
                        logger.warning(f"Groq retornou status {response.status}")
                        
            except Exception as e:
                logger.error(f"Erro ao gerar copy com Groq: {e}")
        
        return self._copy_fallback(produto)
    
    def _copy_fallback(self, produto: Produto) -> str:
        """Copy de fallback quando IA n√£o est√° dispon√≠vel"""
        
        copy = f"OFERTA IMPERD√çVEL - {produto.marketplace}\n\n"
        copy += f"{produto.nome}\n\n"
        
        if produto.desconto > 0:
            copy += f"DE R$ {produto.preco_original:.2f}\n"
            copy += f"POR R$ {produto.preco:.2f}\n"
            copy += f"DESCONTO DE {produto.desconto:.0f}%\n\n"
        else:
            copy += f"PRE√áO: R$ {produto.preco:.2f}\n\n"
        
        if produto.vendas > 100:
            copy += f"J√Å VENDEU MAIS DE {produto.vendas} UNIDADES\n"
        
        if produto.avaliacao >= 4.0:
            copy += f"AVALIA√á√ÉO: {produto.avaliacao}/5.0 ({produto.num_avaliacoes} reviews)\n"
        
        if produto.frete_gratis:
            copy += f"\nFRETE GR√ÅTIS\n"
        
        copy += f"\nCLIQUE AGORA E GARANTA O SEU!"
        
        return copy

# ==================== BOT DO TELEGRAM ====================

class BotMultiAfiliado:
    """Bot do Telegram com todas as funcionalidades"""
    
    def __init__(self):
        self.token = os.getenv('TELEGRAM_BOT_TOKEN')
        
        if not self.token:
            raise ValueError("‚ùå TELEGRAM_BOT_TOKEN n√£o encontrado no .env!")
        
        self.comparador = ComparadorMultiMarketplace()
        self.marketing = MarketingAIGroq()
        self.db = DatabaseManager()
        
        logger.info("‚úì Bot Multi-Afiliado inicializado")
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handler do comando /start"""
        user = update.effective_user
        
        usuario_db = self.db.obter_usuario(user.id)
        if not usuario_db:
            usuario = Usuario(
                user_id=user.id,
                username=user.username or '',
                nome=user.first_name,
                data_registro=datetime.now(),
                ultima_interacao=datetime.now()
            )
            self.db.salvar_usuario(usuario)
            logger.info(f"‚úì Novo usu√°rio registrado: {user.first_name} (ID: {user.id})")
        else:
            usuario_db.ultima_interacao = datetime.now()
            self.db.salvar_usuario(usuario_db)
        
        keyboard = [
            [InlineKeyboardButton("üîç Busca Multi-Marketplace", callback_data='buscar_multi')],
            [InlineKeyboardButton("üèÜ Melhores Ofertas do Dia", callback_data='melhores_ofertas')],
            [InlineKeyboardButton("üìä Comparar Pre√ßos", callback_data='comparar')],
            [
                InlineKeyboardButton("üõí Shopee", callback_data='mk_shopee'),
                InlineKeyboardButton("üì¶ ML", callback_data='mk_ml')
            ],
            [
                InlineKeyboardButton("üì± Amazon", callback_data='mk_amazon'),
                InlineKeyboardButton("üè¨ Magalu", callback_data='mk_magalu')
            ],
            [InlineKeyboardButton("üìà Estat√≠sticas", callback_data='stats')],
            [InlineKeyboardButton("‚öôÔ∏è Meu Perfil", callback_data='perfil')],
            [InlineKeyboardButton("‚ÑπÔ∏è Ajuda", callback_data='ajuda')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        mensagem = f"""ü§ñ MARKETING DE MILH√ïES - BOT

Ol√°, {user.first_name}!

üí∞ Economize em TODAS as suas compras!

üéØ LOJAS INTEGRADAS:
‚úì Shopee | ‚úì Mercado Livre | ‚úì Amazon
‚úì Magazine Luiza | ‚úì AliExpress | ‚úì Olist

üöÄ RECURSOS:
- Busca simult√¢nea em 6+ lojas
- Compara√ß√£o autom√°tica de pre√ßos
- Economia garantida na hora!
- Links diretos para compra

üëá Escolha uma op√ß√£o abaixo:"""
        
        await update.message.reply_text(mensagem, reply_markup=reply_markup)
    
    async def callback_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handler para callbacks dos bot√µes"""
        query = update.callback_query
        await query.answer()
        
        user_id = update.effective_user.id
        data = query.data
        
        if data == 'buscar_multi':
            await query.edit_message_text(
                "üîç BUSCA MULTI-MARKETPLACE\n\n"
                "Digite o nome do produto que voc√™ procura.\n"
                "Vou buscar nas melhores lojas!\n\n"
                "Exemplo: notebook gamer"
            )
            context.user_data['modo'] = 'buscar_multi'
        
        elif data == 'melhores_ofertas':
            await self.mostrar_melhores_ofertas(update, context)
        
        elif data == 'comparar':
            await query.edit_message_text(
                "üìä COMPARA√á√ÉO DE PRE√áOS\n\n"
                "Digite o produto para comparar pre√ßos entre lojas:\n\n"
                "Exemplo: air fryer"
            )
            context.user_data['modo'] = 'comparar'
        
        elif data.startswith('mk_'):
            marketplace = data.replace('mk_', '')
            await self.buscar_marketplace_especifico(update, context, marketplace)
        
        elif data == 'stats':
            await self.mostrar_estatisticas(update, context)
        
        elif data == 'perfil':
            await self.mostrar_perfil(update, context)
        
        elif data == 'ajuda':
            await self.mostrar_ajuda(update, context)
    
    async def processar_mensagem(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Processa mensagens de texto do usu√°rio"""
        modo = context.user_data.get('modo')
        termo = update.message.text.strip()
        
        if not termo:
            await update.message.reply_text("Por favor, digite um termo de busca v√°lido.")
            return
        
        if len(termo) < 3:
            await update.message.reply_text("O termo de busca deve ter pelo menos 3 caracteres.")
            return
        
        if modo == 'buscar_multi':
            await self.executar_busca_multi(update, termo)
            context.user_data['modo'] = None
        
        elif modo == 'comparar':
            await self.executar_comparacao(update, termo)
            context.user_data['modo'] = None
        
        elif modo and modo.startswith('buscar_'):
            marketplace = modo.replace('buscar_', '')
            await self.executar_busca_especifica(update, termo, marketplace)
            context.user_data['modo'] = None
    
    async def executar_busca_multi(self, update: Update, termo: str):
        """Executa busca em todos os marketplaces"""
        msg_progresso = await update.message.reply_text(
            f"üîç Buscando '{termo}' em TODAS as lojas...\n"
            "‚è≥ Aguarde alguns segundos..."
        )
        
        try:
            produtos_por_marketplace = await self.comparador.buscar_todos_marketplaces(termo)
            resultado = self.comparador.comparar_precos(produtos_por_marketplace)
            
            if not resultado['produtos']:
                await msg_progresso.edit_text(
                    f"üòî Nenhum produto encontrado para '{termo}'.\n\n"
                    "Tente:\n"
                    "- Termos mais gen√©ricos\n"
                    "- Verificar ortografia\n"
                    "- Usar palavras-chave diferentes"
                )
                return
            
            resumo = f"‚úÖ RESULTADOS PARA: {termo}\n\n"
            resumo += f"üì¶ Total: {resultado['total_produtos']} produtos\n"
            resumo += f"üèÜ Melhor loja: {resultado['melhor_marketplace']}\n"
            resumo += f"üí∞ Economia m√°xima: R$ {resultado['economia_maxima']:.2f}\n\n"
            resumo += f"üìä DISTRIBUI√á√ÉO:\n"
            
            for marketplace, count in resultado['distribuicao'].items():
                resumo += f"‚Ä¢ {marketplace}: {count} ofertas\n"
            
            resumo += f"\n‚¨áÔ∏è Enviando TOP {min(5, len(resultado['produtos']))} produtos..."
            
            await msg_progresso.edit_text(resumo)
            
            for produto in resultado['produtos'][:5]:
                await self.enviar_produto_completo(update, produto, resultado['produtos'])
                await asyncio.sleep(1)
            
            keyboard = [[InlineKeyboardButton("üîô Voltar ao Menu", callback_data='voltar_menu')]]
            await update.message.reply_text(
                "‚úÖ Busca conclu√≠da!",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
        except Exception as e:
            logger.error(f"Erro na busca multi: {e}")
            await msg_progresso.edit_text(
                "‚ùå Erro ao buscar produtos. Tente novamente em alguns instantes."
            )
    
    async def executar_comparacao(self, update: Update, termo: str):
        """Executa compara√ß√£o de pre√ßos"""
        msg_progresso = await update.message.reply_text(
            f"üìä Comparando pre√ßos de '{termo}'...\n"
            "‚è≥ Isso pode levar alguns segundos..."
        )
        
        try:
            produtos_por_marketplace = await self.comparador.buscar_todos_marketplaces(termo)
            resultado = self.comparador.comparar_precos(produtos_por_marketplace)
            
            if not resultado['produtos']:
                await msg_progresso.edit_text(f"Nenhum produto encontrado para '{termo}'.")
                return
            
            mensagem = "üìä COMPARA√á√ÉO DE PRE√áOS\n"
            mensagem += "=" * 40 + "\n\n"
            
            for marketplace, count in sorted(resultado['distribuicao'].items(), key=lambda x: x[1], reverse=True):
                mensagem += f"üìç {marketplace}: {count} ofertas\n"
            
            mensagem += f"\nüíé Melhor custo-benef√≠cio: {resultado['melhor_marketplace']}\n"
            mensagem += f"üí∞ Economia total poss√≠vel: R$ {resultado['economia_maxima']:.2f}\n\n"
            mensagem += "üèÜ TOP 5 MELHORES OFERTAS:\n"
            mensagem += "=" * 40 + "\n\n"
            
            for i, p in enumerate(resultado['produtos'][:5], 1):
                mensagem += f"{i}. [{p.marketplace}]\n"
                mensagem += f"   {p.nome[:60]}\n"
                mensagem += f"   üíµ R$ {p.preco:.2f}"
                
                if p.economia > 0:
                    mensagem += f" (economize R$ {p.economia:.2f})"
                
                mensagem += f"\n   ‚≠ê {p.avaliacao}/5.0 | üõí {p.vendas}+ vendas\n"
                
                if p.frete_gratis:
                    mensagem += f"   üöö FRETE GR√ÅTIS\n"
                
                mensagem += f"   üîó {p.url_afiliado}\n\n"
            
            await msg_progresso.edit_text(mensagem[:4000])
            
        except Exception as e:
            logger.error(f"Erro na compara√ß√£o: {e}")
            await msg_progresso.edit_text("‚ùå Erro ao comparar pre√ßos.")
    
    async def enviar_produto_completo(self, update: Update, produto: Produto, produtos_similares: List[Produto]):
        """Envia produto com foto, copy e bot√£o de compra"""
        
        try:
            copy = await self.marketing.gerar_copy_multi_marketplace(produto, produtos_similares)
        except Exception as e:
            logger.error(f"Erro ao gerar copy: {e}")
            copy = self.marketing._copy_fallback(produto)
        
        footer = f"\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        footer += f"üè™ Loja: {produto.marketplace}\n"
        footer += f"üíµ Pre√ßo: R$ {produto.preco:.2f}\n"
        
        if produto.desconto > 0:
            footer += f"üî• Desconto: {produto.desconto:.0f}%\n"
            footer += f"üí∞ Economia: R$ {produto.economia:.2f}\n"
        
        footer += f"‚≠ê Avalia√ß√£o: {produto.avaliacao}/5.0 ({produto.num_avaliacoes} reviews)\n"
        footer += f"üõí Vendas: {produto.vendas}+\n"
        
        if produto.frete_gratis:
            footer += f"üöö FRETE GR√ÅTIS\n"
        
        mensagem_final = copy + footer
        
        keyboard = [[
            InlineKeyboardButton(
                f"üõí COMPRAR NO {produto.marketplace.upper()}", 
                url=produto.url_afiliado
            )
        ]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        self.db.registrar_visualizacao(
            update.effective_user.id, 
            produto.id, 
            produto.marketplace
        )
        
        try:
            if produto.imagem and produto.imagem.startswith('http'):
                await update.effective_message.reply_photo(
                    photo=produto.imagem,
                    caption=mensagem_final[:1024],
                    reply_markup=reply_markup
                )
            else:
                await update.effective_message.reply_text(
                    mensagem_final[:4000],
                    reply_markup=reply_markup
                )
        except Exception as e:
            logger.error(f"Erro ao enviar produto: {e}")
            await update.effective_message.reply_text(
                mensagem_final[:4000],
                reply_markup=reply_markup
            )
    
    async def mostrar_melhores_ofertas(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Mostra as melhores ofertas do dia de todos os marketplaces"""
        query = update.callback_query
        
        msg_progresso = await query.edit_message_text(
            "üèÜ Analisando MELHORES OFERTAS em todas as lojas...\n"
            "‚è≥ Aguarde..."
        )
        
        try:
            termos_populares = [
                "smartphone", 
                "notebook", 
                "fone bluetooth",
                "smartwatch",
                "tablet"
            ]
            
            todas_ofertas = []
            
            for termo in termos_populares:
                try:
                    produtos = await self.comparador.buscar_todos_marketplaces(termo)
                    resultado = self.comparador.comparar_precos(produtos)
                    todas_ofertas.extend(resultado['produtos'][:3])
                except Exception as e:
                    logger.error(f"Erro ao buscar {termo}: {e}")
                    continue
            
            if not todas_ofertas:
                await msg_progresso.edit_text("üòî N√£o foi poss√≠vel carregar ofertas no momento.")
                return
            
            todas_ofertas.sort(key=lambda x: x.desconto, reverse=True)
            
            mensagem = "üèÜ TOP OFERTAS DO DIA\n"
            mensagem += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            mensagem += f"üì¶ {len(todas_ofertas)} produtos com descontos incr√≠veis!\n\n"
            
            for i, p in enumerate(todas_ofertas[:15], 1):
                mensagem += f"{i}. {p.marketplace} | {p.desconto:.0f}% OFF\n"
                mensagem += f"   {p.nome[:50]}...\n"
                mensagem += f"   üíµ R$ {p.preco:.2f}"
                
                if p.preco_original > p.preco:
                    mensagem += f" (era R$ {p.preco_original:.2f})"
                
                mensagem += f"\n   üîó {p.url_afiliado}\n\n"
            
            keyboard = [[InlineKeyboardButton("üîô Voltar ao Menu", callback_data='voltar_menu')]]
            
            await msg_progresso.edit_text(
                mensagem[:4000],
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
        except Exception as e:
            logger.error(f"Erro ao mostrar melhores ofertas: {e}")
            await msg_progresso.edit_text("‚ùå Erro ao carregar ofertas. Tente novamente.")
    
    async def buscar_marketplace_especifico(self, update: Update, context: ContextTypes.DEFAULT_TYPE, marketplace: str):
        """Prepara busca em marketplace espec√≠fico"""
        query = update.callback_query
        
        marketplace_nome = {
            'shopee': 'Shopee',
            'ml': 'Mercado Livre',
            'amazon': 'Amazon',
            'magalu': 'Magazine Luiza'
        }.get(marketplace, marketplace)
        
        await query.edit_message_text(
            f"üîç Busca no {marketplace_nome}\n\n"
            f"Digite o produto que voc√™ procura no {marketplace_nome}:\n\n"
            f"Exemplo: t√™nis esportivo"
        )
        
        context.user_data['modo'] = f'buscar_{marketplace}'
    
    async def executar_busca_especifica(self, update: Update, termo: str, marketplace: str):
        """Executa busca em marketplace espec√≠fico"""
        
        marketplace_nome = {
            'shopee': 'Shopee',
            'ml': 'Mercado Livre',
            'amazon': 'Amazon',
            'magalu': 'Magazine Luiza'
        }.get(marketplace, marketplace)
        
        msg = await update.message.reply_text(
            f"üîç Buscando '{termo}' no {marketplace_nome}..."
        )
        
        try:
            if marketplace == 'shopee':
                produtos = await self.comparador.shopee.buscar_produtos(termo, 20)
            elif marketplace == 'ml':
                produtos = await self.comparador.mercadolivre.buscar_produtos(termo, 20)
            elif marketplace == 'amazon':
                produtos = await self.comparador.amazon.buscar_produtos(termo, 20)
            elif marketplace == 'magalu':
                produtos = await self.comparador.magalu.buscar_produtos(termo, 20)
            else:
                produtos = []
            
            if not produtos:
                await msg.edit_text(
                    f"üòî Nenhum produto encontrado no {marketplace_nome} para '{termo}'."
                )
                return
            
            resumo = f"‚úÖ {marketplace_nome}: {len(produtos)} produtos encontrados\n\n"
            resumo += f"‚¨áÔ∏è Enviando TOP {min(5, len(produtos))} produtos..."
            
            await msg.edit_text(resumo)
            
            for produto in produtos[:5]:
                await self.enviar_produto_completo(update, produto, produtos)
                await asyncio.sleep(1)
            
        except Exception as e:
            logger.error(f"Erro na busca espec√≠fica: {e}")
            await msg.edit_text("‚ùå Erro ao buscar produtos.")
    
    async def mostrar_estatisticas(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Mostra estat√≠sticas do sistema"""
        query = update.callback_query
        
        try:
            stats = self.db.obter_estatisticas()
            
            mensagem = "üìà ESTAT√çSTICAS DO SISTEMA\n"
            mensagem += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            mensagem += f"üë• Total de usu√°rios: {stats.get('total_usuarios', 0)}\n\n"
            mensagem += f"üìä HOJE:\n"
            mensagem += f"‚Ä¢ Visualiza√ß√µes: {stats.get('visualizacoes_hoje', 0)}\n"
            mensagem += f"‚Ä¢ Cliques: {stats.get('cliques_hoje', 0)}\n"
            mensagem += f"‚Ä¢ Taxa convers√£o: {stats.get('taxa_conversao', 0)}%\n\n"
            mensagem += f"üìÖ √öLTIMA SEMANA:\n"
            mensagem += f"‚Ä¢ Visualiza√ß√µes: {stats.get('visualizacoes_semana', 0)}\n\n"
            mensagem += f"üí∞ Economia estimada total: R$ {stats.get('economia_total', 0):.2f}\n\n"
            mensagem += f"üèÜ TOP LOJAS:\n"
            
            for i, mp in enumerate(stats.get('top_marketplaces', [])[:5], 1):
                mensagem += f"{i}. {mp.get('nome', 'N/A')}: {mp.get('cliques', 0)} buscas\n"
            
            keyboard = [[InlineKeyboardButton("üîô Voltar ao Menu", callback_data='voltar_menu')]]
            
            await query.edit_message_text(
                mensagem,
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
        except Exception as e:
            logger.error(f"Erro ao mostrar estat√≠sticas: {e}")
            await query.edit_message_text("‚ùå Erro ao carregar estat√≠sticas.")
    
    async def mostrar_perfil(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Mostra perfil do usu√°rio"""
        query = update.callback_query
        user_id = update.effective_user.id
        
        try:
            usuario = self.db.obter_usuario(user_id)
            
            if not usuario:
                await query.edit_message_text("‚ùå Perfil n√£o encontrado.")
                return
            
            dias_desde_registro = (datetime.now() - usuario.data_registro).days
            
            mensagem = "üë§ SEU PERFIL\n"
            mensagem += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            mensagem += f"üìõ Nome: {usuario.nome}\n"
            mensagem += f"üÜî Username: @{usuario.username if usuario.username else 'n√£o definido'}\n"
            mensagem += f"üìÖ Membro h√° {dias_desde_registro} dias\n\n"
            mensagem += f"üìä ESTAT√çSTICAS:\n"
            mensagem += f"‚Ä¢ Produtos visualizados: {usuario.produtos_visualizados}\n"
            mensagem += f"‚Ä¢ Links clicados: {usuario.links_clicados}\n"
            mensagem += f"‚Ä¢ Alertas ativos: {usuario.alertas_ativos}\n"
            mensagem += f"‚Ä¢ Taxa de convers√£o: {usuario.taxa_conversao:.1f}%\n\n"
            mensagem += f"üèÖ N√≠vel: {usuario.nivel_engajamento.upper()}\n\n"
            
            if usuario.marketplaces_favoritos:
                mensagem += f"‚ù§Ô∏è Lojas favoritas:\n"
                mensagem += ", ".join(usuario.marketplaces_favoritos) + "\n\n"
            
            if usuario.preferencias:
                mensagem += f"üîñ Prefer√™ncias:\n"
                mensagem += ", ".join(usuario.preferencias) + "\n\n"
            
            if usuario.ultima_interacao:
                tempo_ultima = datetime.now() - usuario.ultima_interacao
                if tempo_ultima.days > 0:
                    ultima_str = f"h√° {tempo_ultima.days} dias"
                elif tempo_ultima.seconds // 3600 > 0:
                    ultima_str = f"h√° {tempo_ultima.seconds // 3600} horas"
                else:
                    ultima_str = "agora mesmo"
                mensagem += f"üïê √öltima intera√ß√£o: {ultima_str}\n"
            
            keyboard = [[InlineKeyboardButton("üîô Voltar ao Menu", callback_data='voltar_menu')]]
            
            await query.edit_message_text(
                mensagem,
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
        except Exception as e:
            logger.error(f"Erro ao mostrar perfil: {e}")
            await query.edit_message_text("‚ùå Erro ao carregar perfil.")
    
    async def mostrar_ajuda(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Mostra informa√ß√µes de ajuda"""
        query = update.callback_query
        
        mensagem = """‚ÑπÔ∏è AJUDA - MARKETING DE MILH√ïES

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç BUSCA MULTI-MARKETPLACE
Busca simult√¢nea em 6+ lojas. Digite o produto e aguarde os resultados comparados.

üìä COMPARAR PRE√áOS
Compara pre√ßos do mesmo produto entre diferentes lojas, mostrando onde est√° mais barato.

üèÜ MELHORES OFERTAS
Mostra as melhores ofertas do dia com maiores descontos em todas as lojas.

üõí BUSCA POR LOJA
Busca apenas na loja escolhida (Shopee, ML, Amazon, etc).

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí° DICAS:
‚Ä¢ Use termos espec√≠ficos ("notebook gamer i5") para melhores resultados
‚Ä¢ Quanto mais espec√≠fico, melhor a busca
‚Ä¢ Compare sempre antes de comprar
‚Ä¢ Aproveite as ofertas com frete gr√°tis

üí∞ ECONOMIA:
Nosso sistema compara pre√ßos em tempo real para voc√™ sempre economizar!

üìû SUPORTE:
D√∫vidas? @marketingdemilhoes

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"""

        keyboard = [[InlineKeyboardButton("üîô Voltar ao Menu", callback_data='voltar_menu')]]
        
        await query.edit_message_text(
            mensagem,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    async def callback_voltar_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Volta ao menu principal"""
        query = update.callback_query
        await query.answer()
        
        user = update.effective_user
        
        keyboard = [
            [InlineKeyboardButton("üîç Busca Multi-Marketplace", callback_data='buscar_multi')],
            [InlineKeyboardButton("üèÜ Melhores Ofertas do Dia", callback_data='melhores_ofertas')],
            [InlineKeyboardButton("üìä Comparar Pre√ßos", callback_data='comparar')],
            [
                InlineKeyboardButton("üõí Shopee", callback_data='mk_shopee'),
                InlineKeyboardButton("üì¶ ML", callback_data='mk_ml')
            ],
            [
                InlineKeyboardButton("üì± Amazon", callback_data='mk_amazon'),
                InlineKeyboardButton("üè¨ Magalu", callback_data='mk_magalu')
            ],
            [InlineKeyboardButton("üìà Estat√≠sticas", callback_data='stats')],
            [InlineKeyboardButton("‚öôÔ∏è Meu Perfil", callback_data='perfil')],
            [InlineKeyboardButton("‚ÑπÔ∏è Ajuda", callback_data='ajuda')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        mensagem = f"""ü§ñ MARKETING DE MILH√ïES - BOT

Ol√°, {user.first_name}!

üí∞ Economize em TODAS as suas compras!

üéØ LOJAS INTEGRADAS:
‚úì Shopee | ‚úì Mercado Livre | ‚úì Amazon
‚úì Magazine Luiza | ‚úì AliExpress | ‚úì Olist

üëá Escolha uma op√ß√£o:"""
        
        await query.edit_message_text(mensagem, reply_markup=reply_markup)
    
    def run(self):
        """Inicia o bot"""
        app = Application.builder().token(self.token).build()
        
        app.add_handler(CommandHandler("start", self.start))
        app.add_handler(CallbackQueryHandler(self.callback_voltar_menu, pattern='^voltar_menu$'))
        app.add_handler(CallbackQueryHandler(self.callback_handler))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.processar_mensagem))
        
        logger.info("=" * 60)
        logger.info("ü§ñ BOT MARKETING DE MILH√ïES INICIADO")
        logger.info("Lojas: Shopee, ML, Amazon, Magalu, AliExpress, Olist")
        logger.info("Servidor Web: http://localhost:5000")
        logger.info("=" * 60)
        
        app.run_polling(allowed_updates=Update.ALL_TYPES)

# ==================== SERVIDOR WEB ====================

db_web = DatabaseManager()
cache_web = CacheManager(ttl_seconds=60)

app = Flask(__name__)
CORS(app)

# Template HTML completo integrado
HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Marketing de Milh√µes - Comparador de Pre√ßos em Tempo Real com Economia Garantida">
    <meta name="author" content="Marketing de Milh√µes">
    <title>Marketing de Milh√µes - Economia em Compras Online</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1d7c4d 0%, #0f5c3a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .avatar {
            font-size: 80px;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            color: #0f5c3a;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #1d7c4d, #0f5c3a);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .highlight {
            color: #e74c3c;
            font-weight: 700;
            font-size: 18px;
        }

        h3 {
            color: #0f5c3a;
            font-size: 18px;
            margin: 30px 0 15px 0;
            border-bottom: 3px solid #1d7c4d;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-section {
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(29, 124, 77, 0.1), rgba(15, 92, 58, 0.1));
            border-radius: 12px;
            border: 2px solid #1d7c4d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border-left: 4px solid #1d7c4d;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(29, 124, 77, 0.2);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1d7c4d;
            margin-bottom: 5px;
        }

        .stat-value.loading {
            animation: pulse 1.5s infinite;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .savings-banner {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .savings-banner h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .savings-banner p {
            font-size: 14px;
            opacity: 0.9;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .benefit-card {
            background: linear-gradient(135deg, #f0f9f6, #e8f5f0);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            border: 2px solid #1d7c4d;
            transition: all 0.3s ease;
        }

        .benefit-card:hover {
            background: linear-gradient(135deg, #1d7c4d, #0f5c3a);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(29, 124, 77, 0.3);
        }

        .benefit-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .benefit-text {
            font-size: 12px;
            font-weight: 600;
        }

        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .marketplace-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .marketplace-card:hover {
            background: #1d7c4d;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(29, 124, 77, 0.3);
            border-color: #1d7c4d;
        }

        .mp-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .mp-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .mp-commission {
            font-size: 11px;
            color: #e74c3c;
            font-weight: 600;
        }

        .marketplace-card:hover .mp-commission {
            color: #ff9999;
        }

        .mp-status {
            font-size: 10px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .contact-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border-left: 4px solid #1d7c4d;
        }

        .contact-item:hover {
            background: #e8f5f0;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(29, 124, 77, 0.2);
        }

        .icon {
            font-size: 28px;
            min-width: 40px;
            text-align: center;
        }

        .contact-info {
            flex: 1;
        }

        .contact-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .contact-value {
            font-size: 15px;
            color: #0f5c3a;
            font-weight: 600;
            word-break: break-all;
        }

        .copy-indicator {
            font-size: 18px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .contact-item:hover .copy-indicator {
            opacity: 1;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .search-box input {
            flex: 1;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #1d7c4d;
        }

        .search-box button {
            background: linear-gradient(135deg, #1d7c4d, #0f5c3a);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .search-box button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(29, 124, 77, 0.4);
        }

        .search-box button:active {
            transform: scale(0.98);
        }

        .telegram-btn {
            background: linear-gradient(135deg, #0088cc, #00aaff);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.3);
        }

        .telegram-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 136, 204, 0.5);
        }

        .telegram-btn:active {
            transform: scale(0.98);
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 14px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
            border-left: 3px solid #1d7c4d;
        }

        .features-list li:hover {
            background: #e8f5f0;
            transform: translateX(5px);
        }

        .features-list li::before {
            content: '‚úì';
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e8f5f0;
            color: #999;
            font-size: 13px;
        }

        .version {
            font-size: 11px;
            color: #ccc;
            margin: 8px 0;
        }

        .social-links {
            margin-top: 12px;
        }

        .social-links a {
            color: #1d7c4d;
            text-decoration: none;
            font-weight: 600;
            margin: 0 10px;
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: #e74c3c;
            text-decoration: underline;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 26px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-weight: 500;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #1d7c4d;
        }

        .toast.success {
            background: #28a745;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 8px;
            animation: blink 2s infinite;
            box-shadow: 0 0 8px #28a745;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-indicator.offline {
            background: #dc3545;
            animation: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px 20px;
            }

            h1 {
                font-size: 26px;
            }

            .avatar {
                font-size: 60px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 26px;
            }

            .marketplace-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .benefits-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .search-box {
                flex-direction: column;
            }

            .search-box button {
                width: 100%;
            }

            .telegram-btn {
                font-size: 18px;
                padding: 16px;
            }

            .toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="avatar">üí∞</div>
            <h1>Marketing de Milh√µes</h1>
            <p class="subtitle">Comparador Inteligente de Pre√ßos em Tempo Real</p>
            <div class="badge">‚ú® Economia Garantida em Todas as Compras</div>
        </div>

        <div class="savings-banner">
            <h2>üí∏ Economize na Hora!</h2>
            <p>Encontre os melhores pre√ßos em diversas lojas e veja sua economia instantaneamente</p>
        </div>

        <div style="text-align: center; margin: 15px 0; font-size: 13px; color: #0f5c3a;">
            Status do Bot: <strong style="color: #28a745;">üü¢ Online</strong>
            <span class="status-indicator" id="statusIndicator"></span>
        </div>

        <div class="stats-section">
            <h3>
                <span>üìä</span>
                <span>Estat√≠sticas em Tempo Real</span>
            </h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value loading" id="totalUsers">-</div>
                    <div class="stat-label">Usu√°rios Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value loading" id="clicksToday">-</div>
                    <div class="stat-label">Buscas Hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="economySaved"><span class="highlight">R$ -</span></div>
                    <div class="stat-label">Economizado</div>
                </div>
            </div>
        </div>

        <h3>
            <span>‚ö°</span>
            <span>Por Que Usar?</span>
        </h3>
        <div class="benefits-grid">
            <div class="benefit-card">
                <div class="benefit-icon">üîç</div>
                <div class="benefit-text">Pesquisa em Tempo Real</div>
            </div>
            <div class="benefit-card">
                <div class="benefit-icon">üìä</div>
                <div class="benefit-text">Compara√ß√£o Autom√°tica</div>
            </div>
            <div class="benefit-card">
                <div class="benefit-icon">üí∞</div>
                <div class="benefit-text">Pre√ßos Mais Baixos</div>
            </div>
            <div class="benefit-card">
                <div class="benefit-icon">‚ö°</div>
                <div class="benefit-text">Resultado Instant√¢neo</div>
            </div>
        </div>

        <h3>
            <span>üõí</span>
            <span>Lojas Monitoradas</span>
        </h3>
        <div class="marketplace-grid">
            <div class="marketplace-card" onclick="openMarketplace('shopee')">
                <div class="mp-icon">üõçÔ∏è</div>
                <div class="mp-name">Shopee</div>
                <div class="mp-commission">Pre√ßos Baixos</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
            <div class="marketplace-card" onclick="openMarketplace('mercadolivre')">
                <div class="mp-icon">üì¶</div>
                <div class="mp-name">Mercado Livre</div>
                <div class="mp-commission">Maior Variedade</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
            <div class="marketplace-card" onclick="openMarketplace('amazon')">
                <div class="mp-icon">üì±</div>
                <div class="mp-name">Amazon</div>
                <div class="mp-commission">Frete R√°pido</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
            <div class="marketplace-card" onclick="openMarketplace('magalu')">
                <div class="mp-icon">üè¨</div>
                <div class="mp-name">Magalu</div>
                <div class="mp-commission">Cashback</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
            <div class="marketplace-card" onclick="openMarketplace('aliexpress')">
                <div class="mp-icon">üåè</div>
                <div class="mp-name">AliExpress</div>
                <div class="mp-commission">Muito Barato</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
            <div class="marketplace-card" onclick="openMarketplace('olist')">
                <div class="mp-icon">üöÄ</div>
                <div class="mp-name">Olist</div>
                <div class="mp-commission">Promo√ß√µes</div>
                <div class="mp-status">‚úì Ativo</div>
            </div>
        </div>

        <h3>
            <span>üîç</span>
            <span>Busca Multi-Lojas</span>
        </h3>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ex: iPhone, notebook, fone..." onkeypress="handleSearchEnter(event)">
            <button onclick="performSearch()">Buscar</button>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 8px; text-align: center; background: #f0f9f6; padding: 10px; border-radius: 8px;">
            ‚ú® Abra o bot para comparar pre√ßos em <strong>tempo real</strong> e encontrar a melhor economia!
        </p>

        <h3>
            <span>‚ö°</span>
            <span>Principais Recursos</span>
        </h3>
        <ul class="features-list">
            <li>üîç Busca simult√¢nea em 6+ lojas virtuais</li>
            <li>üí∞ Compara√ß√£o autom√°tica e instant√¢nea de pre√ßos</li>
            <li>üìä Mostra economia na hora da compra</li>
            <li>‚ö° Pesquisa em tempo real 24/7</li>
            <li>üìà Alertas de pre√ßos reduzidos</li>
            <li>üí≥ Links diretos para compra segura</li>
            <li>üéØ Produtos com pre√ßos mais baixos destacados</li>
            <li>üì± Interface r√°pida e intuitiva</li>
        </ul>

        <button class="telegram-btn" onclick="openBotTelegram()">
            <span>‚úàÔ∏è</span>
            <span>Abrir Bot - Come√ßar a Economizar!</span>
        </button>

        <h3>
            <span>üìû</span>
            <span>Fale Conosco</span>
        </h3>
        
        <div class="contact-item" onclick="copyToClipboard('https://t.me/marketingdemilhoes_bot', this, 'Bot')">
            <div class="icon">‚úàÔ∏è</div>
            <div class="contact-info">
                <div class="contact-label">Bot Telegram</div>
                <div class="contact-value">@marketingdemilhoes_bot</div>
            </div>
            <div class="copy-indicator">üìã</div>
        </div>

        <div class="contact-item" onclick="copyToClipboard('marketingdemilhoes@gmail.com', this, 'E-mail')">
            <div class="icon">üìß</div>
            <div class="contact-info">
                <div class="contact-label">E-mail</div>
                <div class="contact-value">marketingdemilhoes@gmail.com</div>
            </div>
            <div class="copy-indicator">üìã</div>
        </div>

        <div class="contact-item" onclick="copyToClipboard('https://t.me/marketingdemilhoes', this, 'Telegram')">
            <div class="icon">üí¨</div>
            <div class="contact-info">
                <div class="contact-label">Grupo Telegram</div>
                <div class="contact-value">@marketingdemilhoes</div>
            </div>
            <div class="copy-indicator">üìã</div>
        </div>

        <h3>
            <span>üèÜ</span>
            <span>Lojas Mais Procuradas</span>
        </h3>
        <div id="topMarketplaces" style="min-height: 80px;">
            <p style="text-align: center; color: #999; padding: 20px;">
                Carregando dados...
            </p>
        </div>

        <div class="footer">
            <p>‚ú® Marketing de Milh√µes - Sua Economia em Primeiro Lugar</p>
            <p class="version">v3.0.0 | Sistema de Compara√ß√£o de Pre√ßos | Sempre Atualizado</p>
            <div class="social-links">
                <a href="https://t.me/marketingdemilhoes_bot" target="_blank">Bot Telegram</a>
                <a href="https://t.me/marketingdemilhoes" target="_blank">Grupo</a>
            </div>
            <p style="margin-top: 15px; font-size: 11px;">
                ¬© 2024 Marketing de Milh√µes - Todos os direitos reservados<br>
                Sistema Inteligente de Economia em Compras Online
            </p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        function openBotTelegram() {
            const botUrl = 'https://t.me/marketingdemilhoes_bot';
            window.open(botUrl, '_blank');
            showToast('ü§ñ Abrindo Bot Marketing de Milh√µes...', 'info');
        }

        function copyToClipboard(text, element, label) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast(`‚úì ${label} copiado com sucesso!`, 'success');
                showCopyFeedback(element);
            } catch (err) {
                showToast('‚ùå Erro ao copiar. Tente novamente.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopyFeedback(element) {
            const originalBg = element.style.background;
            element.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
            
            setTimeout(() => {
                element.style.background = originalBg;
            }, 400);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function openMarketplace(marketplace) {
            const urls = {
                shopee: 'https://shopee.com.br',
                mercadolivre: 'https://mercadolivre.com.br',
                amazon: 'https://amazon.com.br',
                magalu: 'https://magazineluiza.com.br',
                aliexpress: 'https://pt.aliexpress.com',
                olist: 'https://www.olist.com.br'
            };
            
            if (urls[marketplace]) {
                window.open(urls[marketplace], '_blank');
                showToast(`Abrindo ${marketplace.toUpperCase()}...`, 'info');
            }
        }

        function performSearch() {
            const input = document.getElementById('searchInput');
            const termo = input.value.trim();
            
            if (!termo) {
                showToast('üìù Digite o nome do produto!', 'error');
                input.focus();
                return;
            }
            
            showToast(`üîç Procurando "${termo}" em todas as lojas...`, 'info');
            
            setTimeout(() => {
                openBotTelegram();
            }, 1500);
        }

        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.data);
                    updateStatusIndicator(true);
                } else {
                    updateStatsError();
                    updateStatusIndicator(false);
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
                updateStatsError();
                updateStatusIndicator(false);
            }
        }

        function updateStats(stats) {
            animateValue('totalUsers', 0, stats.total_usuarios || 0, 1000);
            animateValue('clicksToday', 0, stats.cliques_hoje || 0, 1000);
            
            const economyElement = document.getElementById('economySaved');
            economyElement.innerHTML = `<span class="highlight">R$ ${(stats.economia_total || 0).toLocaleString('pt-BR')}</span>`;

            updateTopMarketplaces(stats.top_marketplaces || []);
        }

        function updateStatsError() {
            document.getElementById('totalUsers').textContent = '-';
            document.getElementById('clicksToday').textContent = '-';
            document.getElementById('economySaved').innerHTML = '<span class="highlight">R$ -</span>';
        }

        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            element.classList.remove('loading');
            
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current).toLocaleString('pt-BR');
            }, 16);
        }

        function updateTopMarketplaces(marketplaces) {
            const container = document.getElementById('topMarketplaces');
            
            if (!marketplaces || marketplaces.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhum dado dispon√≠vel</p>';
                return;
            }

            const maxClicks = Math.max(...marketplaces.map(m => m.cliques), 1);
            
            let html = '<div style="padding: 10px 0;">';
            marketplaces.forEach((mp, index) => {
                const percentage = (mp.cliques / maxClicks) * 100;
                const icons = {
                    'Shopee': 'üõçÔ∏è',
                    'Mercado Livre': 'üì¶',
                    'Amazon': 'üì±',
                    'Magazine Luiza': 'üè¨',
                    'AliExpress': 'üåè',
                    'Olist': 'üöÄ'
                };
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 13px; font-weight: 600; color: #0f5c3a;">
                                <span style="font-size: 16px;">${icons[mp.nome] || 'üìä'}</span> 
                                ${index + 1}. ${mp.nome}
                            </span>
                            <span style="font-size: 13px; font-weight: 600; color: #e74c3c;">
                                ${mp.cliques} buscas
                            </span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #1d7c4d, #0f5c3a); transition: width 1s ease;"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateStatusIndicator(isOnline) {
            const indicator = document.getElementById('statusIndicator');
            if (isOnline) {
                indicator.classList.remove('offline');
            } else {
                indicator.classList.add('offline');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Marketing de Milh√µes - Sistema Iniciado');
            
            setTimeout(() => {
                loadStats();
            }, 500);
            
            setInterval(() => {
                loadStats();
            }, 30000);
            
            setTimeout(() => {
                showToast('üí∞ Bem-vindo ao Marketing de Milh√µes!', 'success');
            }, 1000);
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                openBotTelegram();
            }
        });

        let clickCount = 0;
        document.querySelector('.avatar').addEventListener('click', () => {
            clickCount++;
            if (clickCount === 5) {
                showToast('üéâ Cupom especial: ECONOMIZE50 - 50% OFF!', 'success');
                clickCount = 0;
            }
        });

        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë   MARKETING DE MILH√ïES - COMPARADOR DE PRE√áOS        ‚ïë
        ‚ïë   Sistema de Economia em Compras Online              ‚ïë
        ‚ïë   Bot: @marketingdemilhoes_bot                       ‚ïë
        ‚ïë   Vers√£o: 3.0.0                                      ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        
        Atalhos:
        ‚Ä¢ Ctrl+K: Focar busca
        ‚Ä¢ Ctrl+T: Abrir Telegram
        ‚Ä¢ 5 cliques no avatar: Easter egg
        `);
    </script>
</body>
</html>"""

@app.route('/')
def index():
    """P√°gina principal"""
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/stats')
def api_stats():
    """API de estat√≠sticas em tempo real"""
    try:
        cached = cache_web.get('stats')
        if cached:
            return jsonify({
                'success': True,
                'data': cached,
                'cached': True
            })
        
        stats = db_web.obter_estatisticas()
        cache_web.set('stats', stats)
        
        return jsonify({
            'success': True,
            'data': stats,
            'cached': False
        })
    except Exception as e:
        logger.error(f"Erro API stats: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/health')
def health():
    """Health check"""
    return jsonify({
        'status': 'online',
        'timestamp': datetime.now().isoformat(),
        'version': '3.0.0',
        'services': {
            'bot': 'running',
            'database': 'connected',
            'web': 'running'
        }
    })

@app.route('/api/marketplaces')
def api_marketplaces():
    """Lista de marketplaces integrados"""
    marketplaces = [
        {'nome': 'Shopee', 'status': 'ativo', 'comissao_media': 8.0},
        {'nome': 'Mercado Livre', 'status': 'ativo', 'comissao_media': 6.0},
        {'nome': 'Amazon', 'status': 'em_configuracao', 'comissao_media': 4.0},
        {'nome': 'Magazine Luiza', 'status': 'em_configuracao', 'comissao_media': 5.0},
        {'nome': 'AliExpress', 'status': 'em_configuracao', 'comissao_media': 8.0},
        {'nome': 'Olist', 'status': 'planejado', 'comissao_media': 7.0}
    ]
    
    return jsonify({
        'success': True,
        'data': marketplaces
    })

def run_web_server():
    """Inicia servidor Flask"""
    logger.info("üåê Iniciando servidor web na porta 5000...")
    logger.info("üìç Acesse: http://localhost:5000")
    app.run(host='0.0.0.0', port=5000, debug=False, use_reloader=False, threaded=True)

# ==================== MAIN ====================

if __name__ == '__main__':
    print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë        BOT MARKETING DE MILH√ïES v3.0                    ‚ïë
    ‚ïë                                                          ‚ïë
    ‚ïë   üéØ Lojas Integradas:                                  ‚ïë
    ‚ïë   ‚Ä¢ Shopee (busca ativa)                               ‚ïë
    ‚ïë   ‚Ä¢ Mercado Livre (busca ativa)                        ‚ïë
    ‚ïë   ‚Ä¢ Amazon (em configura√ß√£o)                            ‚ïë
    ‚ïë   ‚Ä¢ Magazine Luiza (em configura√ß√£o)                    ‚ïë
    ‚ïë   ‚Ä¢ AliExpress (em configura√ß√£o)                        ‚ïë
    ‚ïë   ‚Ä¢ Olist (planejado)                                   ‚ïë
    ‚ïë                                                          ‚ïë
    ‚ïë   üöÄ Recursos:                                          ‚ïë
    ‚ïë   ‚Ä¢ Busca multi-loja simult√¢nea                         ‚ïë
    ‚ïë   ‚Ä¢ Compara√ß√£o autom√°tica de pre√ßos                     ‚ïë
    ‚ïë   ‚Ä¢ Copy marketing com IA (Groq)                        ‚ïë
    ‚ïë   ‚Ä¢ Rate limiting inteligente                           ‚ïë
    ‚ïë   ‚Ä¢ Cache para performance                              ‚ïë
    ‚ïë   ‚Ä¢ Dashboard web em tempo real                         ‚ïë
    ‚ïë   ‚Ä¢ Rastreamento completo                               ‚ïë
    ‚ïë                                                          ‚ïë
    ‚ïë   üìä Servidor Web: http://localhost:5000                ‚ïë
    ‚ïë   üë§ Sistema: Marketing de Milh√µes                      ‚ïë
    ‚ïë   üìÖ Vers√£o: 3.0.0                                      ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    
    üîß Iniciando sistema...
    """)
    
    try:
        if not os.getenv('TELEGRAM_BOT_TOKEN'):
            logger.error("‚ùå TELEGRAM_BOT_TOKEN n√£o encontrado no arquivo .env!")
            print("\n‚ö†Ô∏è  Configure o arquivo .env com suas credenciais:")
            print("TELEGRAM_BOT_TOKEN=seu_token_aqui")
            print("GROQ_API_KEY=sua_chave_aqui")
            print("SHOPEE_AFFILIATE_CODE=seu_codigo_aqui")
            print("MERCADOLIVRE_AFFILIATE_ID=seu_id_aqui")
            exit(1)
        
        web_thread = threading.Thread(target=run_web_server, daemon=True)
        web_thread.start()
        
        import time
        time.sleep(2)
        
        logger.info("‚úÖ Servidor web iniciado com sucesso")
        
        bot = BotMultiAfiliado()
        bot.run()
        
    except KeyboardInterrupt:
        logger.info("\n\n‚ö†Ô∏è  Bot interrompido pelo usu√°rio")
        print("\nüëã At√© logo!")
    except Exception as e:
        logger.error(f"‚ùå Erro fatal: {e}")
        import traceback
        traceback.print_exc()
